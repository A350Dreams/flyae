<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Europa Virtual (AEV) - Book a Flight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" href="https://placehold.co/16x16/3B82F6/fff?text=AE" type="image/png" />
    <style>
        /* CUSTOM CSS FOR THE SLEEK, HIGH-TECH & INTUITIVE DESIGN */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            overflow-x: hidden;
            background-color: #F8FAFC; /* Lightest blue-gray for the main background */
            color: #334155; /* Slate-700 for main body text */
        }
        h1, h2, h3, h4 {
            font-family: 'Inter', sans-serif; /* All headings use Inter */
            font-weight: 800; /* Extra bold for most headings */
            color: #0F172A; /* Darker slate-900 for strong headings */
        }
        h1 { font-weight: 900; } /* Even bolder for the main title */

        /* Custom scrollbar - sleek & modern */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #E2E8F0; /* Light track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #64748B; /* Medium gray thumb */
            border-radius: 10px;
            border: 2px solid #F8FAFC; /* Matches body background for subtle depth */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; /* Darker on hover */
            cursor: pointer;
        }

        /* Header and Nav - Consistent with index.html */
        .header-sleek {
            background-color: #FFFFFF; /* White header background */
            border-bottom: 1px solid #E2E8F0; /* Subtle bottom border */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Soft shadow */
            padding-top: 1rem; /* Adjust padding for visual balance */
            padding-bottom: 1rem;
        }
        .nav-link-sleek {
            position: relative;
            font-weight: 500;
            color: #4A5568; /* Gray-700 for links */
            transition: color 0.3s ease;
            padding: 0.5rem 0; /* Vertical padding for the link text */
        }
        .nav-link-sleek::after {
            content: '';
            position: absolute;
            bottom: -6px; /* Space below link for underline */
            left: 0;
            width: 0%;
            height: 3px;
            background-color: #3B82F6; /* Bright blue accent */
            border-radius: 2px;
            transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smooth expansion */
        }
        .nav-link-sleek:hover {
            color: #1D4ED8; /* Darker blue on hover */
        }
        .nav-link-sleek:hover::after {
            width: 100%;
        }

        /* Section Backgrounds/Cards - Consistent with index.html */
        .card-background-sleek {
            background-color: #FFFFFF; /* Pure white background for sections */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08); /* Soft but noticeable shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #E2E8F0; /* Light gray border */
        }

        /* Form Container Specific Styling - Adapting the sleek card style */
        .form-container-sleek {
            background-color: #F0F4F8; /* Light blue-gray for the inner form background */
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            border: 1px solid #E2E8F0;
        }

        /* Input/Select fields - Sleek and modern */
        .input-field-sleek {
            background-color: #FFFFFF; /* White background for inputs */
            border: 1px solid #CBD5E1; /* Light gray border */
            color: #1E293B; /* Dark text for input values */
            padding: 1rem 1.5rem;
            border-radius: 0.75rem; /* Rounded corners for inputs */
            font-size: 1.1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field-sleek:focus {
            outline: none;
            border-color: #3B82F6; /* Bright blue focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); /* Subtle blue glow on focus */
        }
        .input-field-sleek option {
            background-color: #FFFFFF; /* White options in dropdown */
            color: #1E293B;
        }

        /* Submit Button - Consistent with index.html primary button */
        .btn-submit-sleek {
            background: linear-gradient(90deg, #1D4ED8, #3B82F6); /* Strong blue gradient */
            color: white;
            padding: 1.25rem 3.5rem; /* Generous padding */
            border-radius: 9999px; /* Pill shape */
            font-weight: 700; /* Bolder text */
            transition: all 0.4s ease;
            box-shadow: 0 10px 25px rgba(29, 78, 216, 0.4); /* Blue shadow */
            letter-spacing: 0.08em; /* Slightly wider spacing */
            text-transform: uppercase;
        }
        .btn-submit-sleek:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and slight scale */
            box-shadow: 0 15px 35px rgba(29, 78, 216, 0.6); /* Deeper blue shadow on hover */
            background: linear-gradient(90deg, #3B82F6, #1D4ED8); /* Reverse gradient on hover */
        }
        .btn-submit-sleek:disabled {
            background: #CBD5E1; /* Light gray background for disabled state */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-submit-sleek:disabled:hover {
            background: #CBD5E1;
            transform: none;
            box-shadow: none;
        }


        /* Section Heading - Consistent with index.html */
        .section-heading-sleek {
            position: relative;
            padding-bottom: 1rem;
            margin-bottom: 3rem;
            display: inline-block; /* Allows text-align center on parent and width based on content */
            font-size: 3rem; /* Larger heading */
            letter-spacing: 0.03em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.02);
            color: #1A202C; /* Dark charcoal for heading text */
        }
        .section-heading-sleek::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #1D4ED8); /* Blue gradient underline */
            border-radius: 2px;
        }

        /* Custom Message Box - Adapted for sleek design */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out; /* Smoother transition */
        }
        .message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box-content {
            background-color: #FFFFFF; /* White background for modal */
            padding: 3.5rem 3rem; /* More padding */
            border-radius: 1.5rem; /* Larger border-radius */
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.45); /* Deeper shadow */
            text-align: center;
            max-width: 90%;
            width: 500px; /* Slightly wider modal */
            transform: translateY(-40px); /* More pronounced initial translateY */
            transition: transform 0.5s ease-out; /* Smoother transform */
            border: 2px solid #3B82F6; /* Bright blue border */
            color: #1E293B; /* Dark text */
        }
        .message-box-overlay.show .message-box-content {
            transform: translateY(0);
        }
        .message-box-content h3 {
            color: #1D4ED8; /* Darker blue for title */
            margin-bottom: 1rem;
            font-size: 2.5rem; /* Larger title */
            font-weight: 800;
        }
        .message-box-content p {
            margin-bottom: 2rem;
            font-size: 1.2rem;
            line-height: 1.7;
            color: #4A5568; /* Slate-700 for message text */
        }
        .message-box-content button {
            background: linear-gradient(90deg, #EF4444, #DC2626); /* Red gradient for close */
            color: white;
            padding: 1rem 3rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .message-box-content button:hover {
            background: linear-gradient(90deg, #DC2626, #EF4444); /* Reverse gradient on hover */
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6);
        }

        /* General container and section padding adjustments */
        .container-sleek {
            max-width: 1300px; /* Consistent with main page's container width */
        }
        .py-section-sleek {
            padding-top: 7rem;
            padding-bottom: 7rem;
        }
        .mb-content-sleek {
            margin-bottom: 6rem;
        }

        /* Footer - Consistent with index.html */
        .footer-sleek {
            background-color: #0F172A; /* Darkest blue-gray for the footer */
            color: #CBD5E1; /* Light text for footer */
            border-top: 1px solid #1E293B; /* Subtle border */
            padding-top: 3rem;
            padding-bottom: 3rem;
            box-shadow: inset 0 8px 20px rgba(0, 0, 0, 0.2); /* Inner shadow for depth */
        }
        .footer-logo {
            filter: brightness(1.2); /* Make the logo stand out a bit more on dark background */
        }

        /* Discord Login Button and User Info Styling */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem; /* Space between nav links and user actions */
        }

        .discord-login-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 2rem;
            background: linear-gradient(90deg, #7289DA, #5A6FAE); /* Discord blue gradient */
            color: white;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(114, 137, 218, 0.4);
        }

        .discord-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(114, 137, 218, 0.6);
            background: linear-gradient(90deg, #5A6FAE, #7289DA); /* Reverse gradient on hover */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background-color: #F0F4F8; /* Light background for user info */
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            border: 1px solid #E2E8F0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #3B82F6; /* Accent border for avatar */
        }

        .user-info span {
            font-weight: 600;
            color: #1E293B; /* Darker text for username */
        }

        .logout-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 2rem;
            background: linear-gradient(90deg, #EF4444, #DC2626); /* Red gradient for logout */
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.6);
            background: linear-gradient(90deg, #DC2626, #EF4444); /* Reverse gradient on hover */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <header class="header-sleek py-4 px-6 md:px-12">
        <div class="container container-sleek mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img src="https://placehold.co/40x40/3B82F6/fff?text=AE" alt="AEV Logo" class="h-16 w-16 rounded-full shadow-lg border border-blue-300 footer-logo">
                <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide text-gray-900">Air Europa <span class="text-blue-600">Virtual</span></h1>
            </div>
            <nav class="flex-grow flex justify-center md:justify-end">
                <ul class="flex flex-wrap justify-center md:space-x-8 space-x-4">
                    <li><a href="index.html" class="nav-link-sleek text-lg">Home</a></li>
                   
                </ul>
            </nav>
            <div class="user-actions flex-shrink-0 mt-4 md:mt-0">
                </div>
        </div>
    </header>

    <main class="container container-sleek mx-auto py-section-sleek px-6 md:px-12">
        <section id="booking-form-section" class="card-background-sleek p-8 md:p-12 mb-content-sleek relative overflow-hidden">
            <h2 class="section-heading-sleek text-center mx-auto mb-10">Book Your Virtual Flight</h2>
            <p class="text-center text-lg mb-10 max-w-2xl mx-auto text-slate-500">
                Plan your next virtual journey with Air Europa Virtual. Select your departure, arrival, and flight details below.
            </p>

            <div class="max-w-xl mx-auto form-container-sleek">
                <form id="flightBookingForm" class="space-y-6">
                    <input type="hidden" name="Discord Username" id="discordUsernameHidden">
                    <div>
                        <label for="origin" class="block text-slate-700 text-sm font-semibold mb-2">Departure Airport:</label>
                        <select id="origin" name="Departure Airport" class="input-field-sleek w-full" required>
                            <option value="">Select Departure Airport</option>
                            </select>
                    </div>

                    <div>
                        <label for="destination" class="block text-slate-700 text-sm font-semibold mb-2">Arrival Airport:</label>
                        <select id="destination" name="Arrival Airport" class="input-field-sleek w-full" required>
                            <option value="">Select Arrival Airport</option>
                            </select>
                    </div>

                    <div>
                        <label for="flight-date" class="block text-slate-700 text-sm font-semibold mb-2">Departure Date:</label>
                        <input type="date" id="flight-date" name="Departure Date" class="input-field-sleek w-full" required>
                    </div>

                    <div>
                        <label for="passengers" class="block text-slate-700 text-sm font-semibold mb-2">Number of Passengers:</label>
                        <input type="number" id="passengers" name="Number of Passengers" min="1" value="1" class="input-field-sleek w-full" required>
                    </div>

                    <div>
                        <label for="flight-class" class="block text-slate-700 text-sm font-semibold mb-2">Class:</label>
                        <select id="flight-class" name="Flight Class" class="input-field-sleek w-full" required>
                            <option value="Economy">Economy</option>
                            <option value="Business">Business</option>
                            <option value="First Class">First Class</option>
                        </select>
                    </div>

                    <div class="flex justify-center pt-4">
                        <button type="submit" id="submitButton" class="btn-submit-sleek">
                            Submit Booking
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <h3 id="messageBoxTitle" class="text-2xl font-bold"></h3>
            <p id="messageBoxText"></p>
            <button id="messageBoxCloseButton">Close</button>
        </div>
    </div>

    <footer class="footer-sleek py-8 px-6 md:px-12 mt-16">
        <div class="container container-sleek mx-auto text-center">
            <p class="text-lg mb-4">&copy; 2024 Air Europa Virtual. All rights reserved.</p>
            <p class="text-sm opacity-80 mb-6">
                This site is a virtual simulation and is not affiliated with Air Europa or any other real entity.
            </p>
        </div>
    </footer>

    <!-- Firebase SDKs and script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD09Wu6-wyIIDKkGi4TKhn4NKax1r7AWUk",
            authDomain: "flyae-backend.firebaseapp.com",
            projectId: "flyae-backend",
            storageBucket: "flyae-backend.firebasestorage.app",
            messagingSenderId: "610108789668",
            appId: "1:610108789668:web:ae0d71ab7970b0dbb72731",
            measurementId: "G-MHQJ6BBW4G"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Your Discord Client ID from the Discord Developer Portal
        const CLIENT_ID = "1394071712517328947";
        // The Redirect URI must EXACTLY match what's configured in your Discord OAuth2 settings
        const REDIRECT_URI = "https://a350dreams.github.io/flyae/flightbooking.html/"; 

        // Discord authorization URL - CRITICAL: Changed response_type to 'token'
        const AUTH_URL = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;

        // Select the div where user actions will be displayed
        const userActionsDiv = document.querySelector(".user-actions");
        const submitButton = document.getElementById("submitButton");

        // Function to display user information and the logout button
        function showUser(user) {
          const avatarUrl = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : 'https://discord.com/assets/f135b1fcd3d2c4935480d19e910540d5.png'; 
          userActionsDiv.innerHTML = `
            <div class="user-info">
              <img src="${avatarUrl}" alt="User Avatar">
              <span>${user.discriminator && user.discriminator !== '0' ? `${user.username}#${user.discriminator}` : user.username}</span>
            </div>
            <button id="logout-btn" class="logout-button">Logout</button>
          `;

          document.getElementById("logout-btn").onclick = () => {
            localStorage.removeItem("discordUser");
            window.location.href = REDIRECT_URI; // Reload to reset state and clear URL hash
          };
        }

        // Function to display the Discord login button
        function showLoginButton() {
          userActionsDiv.innerHTML = `
            <a href="${AUTH_URL}" class="discord-login-btn">Login with Discord</a>
          `;
        }

        // --- Main login state management logic ---
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get("access_token"); // We are now expecting 'access_token'

        const savedUser = JSON.parse(localStorage.getItem("discordUser"));

        if (token) {
          // If a token is present in the URL (after a new Discord login)
          window.history.replaceState({}, document.title, REDIRECT_URI); // Clean the URL

          fetch("https://discord.com/api/users/@me", {
            headers: {
              Authorization: `Bearer ${token}`
            }
          })
          .then(res => {
            if (!res.ok) {
              console.error("Discord API error:", res.status, res.statusText);
              localStorage.removeItem("discordUser"); // Clear stale user data
              showLoginButton();
              submitButton.disabled = true; // Disable button on API error
              throw new Error("Failed to fetch user data from Discord");
            }
            return res.json();
          })
          .then(user => {
            if (user.id) {
              localStorage.setItem("discordUser", JSON.stringify(user));
              showUser(user);
              submitButton.disabled = false; // Enable button on successful login
            } else {
              console.error("Invalid Discord user data received:", user);
              localStorage.removeItem("discordUser");
              showLoginButton();
              submitButton.disabled = true;
            }
          })
          .catch(error => {
            console.error("Error during Discord user fetch or processing:", error);
            localStorage.removeItem("discordUser");
            showLoginButton();
            submitButton.disabled = true;
          });
        } else if (savedUser) {
          showUser(savedUser);
          submitButton.disabled = false; // Enable button if user is already logged in
        } else {
          showLoginButton();
          submitButton.disabled = true; // Disable button if no user is logged in
        }


        // List of unique airports extracted from the provided image
        const airports = [
            "Gran Canaria", "Punta Cana", "Larnaca", "London Gatwick",
            "London Southampton", "Kittila", "Cibao", "Arroyo Barril", "Menorca"
        ].sort(); // Sort alphabetically for better user experience

        // Function to show custom message box
        function showMessageBox(title, message) {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            
            messageBoxTitle.textContent = title;
            messageBoxText.textContent = message;
            messageBoxOverlay.classList.add('show');
        }

        // Function to hide custom message box
        function hideMessageBox() {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            messageBoxOverlay.classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const originSelect = document.getElementById('origin');
            const destinationSelect = document.getElementById('destination');
            const flightBookingForm = document.getElementById('flightBookingForm');
            const discordUsernameHidden = document.getElementById('discordUsernameHidden');
            const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');

            // Populate dropdowns with airport options
            function populateAirportSelects() {
                airports.forEach(airport => {
                    const optionOrigin = document.createElement('option');
                    optionOrigin.value = airport;
                    optionOrigin.textContent = airport;
                    originSelect.appendChild(optionOrigin);

                    const optionDestination = document.createElement('option');
                    optionDestination.value = airport;
                    optionDestination.textContent = airport;
                    destinationSelect.appendChild(optionDestination);
                });
            }

            populateAirportSelects();

            // Populate Discord username from localStorage
            const userFromLocalStorage = JSON.parse(localStorage.getItem("discordUser"));
            if (userFromLocalStorage && userFromLocalStorage.username) {
                // For modern Discord usernames (without discriminator)
                const username = userFromLocalStorage.discriminator && userFromLocalStorage.discriminator !== '0'
                    ? `${userFromLocalStorage.username}#${userFromLocalStorage.discriminator}`
                    : userFromLocalStorage.username;
                discordUsernameHidden.value = username;
            } else {
                discordUsernameHidden.value = "Not Logged In (or error)";
            }

            // --- FORM SUBMISSION LOGIC ---
            flightBookingForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission
                
                // Check if user is logged in before allowing submission
                if (discordUsernameHidden.value === "Not Logged In (or error)") {
                    showMessageBox("Login Required", "You must log in with Discord before booking a flight.");
                    return;
                }

                const origin = originSelect.value;
                const destination = destinationSelect.value;
                const flightDate = document.getElementById('flight-date').value;
                const passengers = document.getElementById('passengers').value;
                const flightClass = document.getElementById('flight-class').value;

                // Basic validation
                if (origin === "" || destination === "" || flightDate === "" || passengers === "" || flightClass === "") {
                    showMessageBox("Validation Error", "Please fill in all flight details.");
                    return;
                }

                if (origin === destination) {
                    showMessageBox("Invalid Route", "Departure and Arrival airports cannot be the same. Please select different airports.");
                    return;
                }
                
                const bookingData = {
                    discordUsername: discordUsernameHidden.value,
                    origin: origin,
                    destination: destination,
                    flightDate: flightDate,
                    passengers: parseInt(passengers, 10),
                    flightClass: flightClass,
                    timestamp: new Date().toISOString()
                };

                try {
                    // Get a reference to the bookings collection
                    // The path is /artifacts/{appId}/public/data/flight_bookings
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const bookingsCollectionPath = `/artifacts/${appId}/public/data/flight_bookings`;
                    const bookingsRef = collection(db, bookingsCollectionPath);
                    
                    // Add the new booking document to Firestore
                    await addDoc(bookingsRef, bookingData);
                    
                    showMessageBox("Booking Confirmed!", "Your flight booking has been successfully submitted. Thank you for choosing AEV!");
                    flightBookingForm.reset(); // Clear form after successful submission
                } catch (error) {
                    console.error('Error submitting booking:', error);
                    showMessageBox("Submission Failed", "There was an error submitting your booking. Please try again later.");
                }
            });

            // Close message box when button is clicked
            messageBoxCloseButton.addEventListener('click', hideMessageBox);
            // Close message box if clicking outside the content
            messageBoxOverlay.addEventListener('click', (event) => {
                if (event.target === messageBoxOverlay) {
                    hideMessageBox();
                }
            });
        });
    </script>
</body>
</html>
